<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melway Road Change Timeline</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />

    <style>
      #map {
        width: 100%;
        height: 60vh; /* ä½”ç•«é¢ 60% é«˜ */
        min-height: 420px;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid mt-3">
      <!-- åœ°åœ– -->
      <div class="row">
        <div class="col justify-content-center align-items-center">
          <div id="map"></div>
        </div>
      </div>

      <!-- å¹´ä»½æŒ‰éˆ• -->
      <div class="row justify-content-center mt-4">
        <div class="col-auto">
          <div class="btn-group" role="group" id="yearButtons"></div>
        </div>
      </div>

      <!-- åœ–å±¤é–‹é—œæŒ‰éˆ• -->
      <div class="row justify-content-center mt-3">
        <div class="col-auto">
          <div class="btn-group" role="group" aria-label="Layer toggles">
            <button id="btnAdded" type="button" class="btn btn-outline-primary">
              Added
            </button>
            <button
              id="btnPersisted"
              type="button"
              class="btn btn-outline-success"
            >
              Remained
            </button>
            <button
              id="btnDisappeared"
              type="button"
              class="btn btn-outline-danger"
            >
              Disappeared
            </button>
          </div>
        </div>
      </div>

      <!-- èªªæ˜å€ï¼ˆå¯ç•™å¯åˆªï¼‰ -->
      <div class="row justify-content-center mt-4">
        <div class="col-10 col-md-6">
          <div class="card p-3 shadow-sm">
            <h5>Road Type Explanation</h5>
            <ul style="list-style: none; padding-left: 0; margin-bottom: 0">
              <li>
                <span style="color: #666666; font-weight: bold">â– </span>
                Historical DB â€“ Base road network (historical_db.geojson).
              </li>
              <li>
                <span style="color: #007bff; font-weight: bold">â– </span>
                Added â€“ Road that appears in the later year but not in the
                earlier one.
              </li>
              <li>
                <span style="color: #40be7f; font-weight: bold">â– </span>
                Remained â€“ Road exists in both years.
              </li>
              <li>
                <span style="color: #ff0000; font-weight: bold">â– </span>
                Disappeared â€“ Road existed historically but not in the later
                year.
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="mb-5"></div>
    </div>

    <!-- JS Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
      /* ===============================
     å¹´ä»½ & å€å¡Šè¨­å®š
  ================================== */

      const years = ["2001", "2006", "2011", "2020"];
      const blocks = ["m003", "m004", "m005", "m006", "m007"];

      // ä¸»é«”åº•åœ–ï¼šæ¯å€‹ year / block éƒ½æœ‰ historical_db.geojson
      const baseType = "historical_db_final";
      const defaultYear = "2020";

      // å¯åˆ‡æ›é¡¯ç¤ºçš„è®ŠåŒ–åœ–å±¤
      const changeTypes = ["added", "persisted", "disappeared"];

      const layerColors = {
        added: "#007bff",
        disappeared: "#ff0000",
        persisted: "#40be7f",
        historical_db: "#666666",
      };

      /* ===============================
     åˆå§‹åŒ–åœ°åœ–ï¼ˆä¸åšä»»ä½•è‡ªå‹•ç¸®æ”¾ï¼‰
  ================================== */

      var map = L.map("map").setView([-37.75, 145.0], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      /* ===============================
     åœ–å±¤ç®¡ç†
  ================================== */

      let layerGroups = {
        historical_db: [],
        added: [],
        disappeared: [],
        persisted: [],
      };

      let initialBoundsGroup = L.featureGroup(); // ç”¨ä¾†ç®—åˆå§‹ç¯„åœ
      let hasFittedBounds = false; // åª fit ä¸€æ¬¡

      // ä¸‰å€‹ toggle ç‹€æ…‹ï¼ˆé è¨­éƒ½é—œï¼‰
      let visible = {
        added: false,
        persisted: false,
        disappeared: false,
      };

      function clearYearLayers() {
        // åˆ‡æ›å¹´ä»½æ™‚ï¼šhistorical_db + ä¸‰ç¨®è®ŠåŒ–åœ–å±¤éƒ½æ¸…æ‰
        for (let type in layerGroups) {
          layerGroups[type].forEach((layer) => map.removeLayer(layer));
          layerGroups[type] = [];
        }
      }

      function applyVisibility(type) {
        // åªç”¨æ–¼ added/persisted/disappearedï¼›historical_db æ°¸é é¡¯ç¤º
        layerGroups[type].forEach((layer) => {
          if (visible[type]) map.addLayer(layer);
          else map.removeLayer(layer);
        });
      }

      /* ===============================
     è¼‰å…¥æŸä¸€å¹´ï¼šå…ˆè¼‰ historical_dbï¼Œå†è¼‰è®ŠåŒ–åœ–å±¤
     âœ… ä¸åš fitBoundsï¼Œç•«é¢ä½ç½®æ°¸é ä¸å‹•
  ================================== */

      function loadYear(year) {
        clearYearLayers();

        blocks.forEach((block) => {
          // 1) historical_dbï¼šä¸»é«”ï¼Œæ°¸é é¡¯ç¤º
          {
            const url = `melway_outputs/${year}/${block}/${baseType}.geojson`;

            fetch(url)
              .then((res) => res.json())
              .then((data) => {
                const layer = L.geoJSON(data, {
                  style: { color: layerColors.historical_db, weight: 2 },
                });
                layerGroups.historical_db.push(layer);
                layer.addTo(map);

                // ğŸ”‘ åªåœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥é è¨­å¹´ä»½æ™‚ï¼Œç´¯ç© bounds
                if (!hasFittedBounds && year === defaultYear) {
                  initialBoundsGroup.addLayer(layer);
                }
              })
              .catch(() => {
                // ç¼ºæª”å°±è·³é
              });
          }

          // 2) added / persisted / disappearedï¼šä¾ toggle ç‹€æ…‹é¡¯ç¤º
          changeTypes.forEach((type) => {
            const url = `melway_outputs/${year}/${block}/${type}.geojson`;

            fetch(url)
              .then((res) => res.json())
              .then((data) => {
                const layer = L.geoJSON(data, {
                  style: { color: layerColors[type], weight: 2 },
                });

                layerGroups[type].push(layer);

                if (visible[type]) layer.addTo(map);
              })
              .catch(() => {
                // ç¼ºæª”/404 å°±è·³éï¼Œä¸å½±éŸ¿å…¶ä»–
              });
          });
        });

        // ğŸ”’ åˆå§‹è¦–è§’ï¼šåªåšä¸€æ¬¡
        if (!hasFittedBounds && year === defaultYear) {
          setTimeout(() => {
            if (initialBoundsGroup.getLayers().length > 0) {
              map.fitBounds(initialBoundsGroup.getBounds(), {
                padding: [20, 20],
                maxZoom: 17,
              });
              hasFittedBounds = true;
            }
          }, 300);
        }
      }

      /* ===============================
     å¹´ä»½æŒ‰éˆ•
  ================================== */

      const btnGroup = document.getElementById("yearButtons");

      years.forEach((yr, idx) => {
        let btn = document.createElement("button");
        btn.className = "btn btn-outline-primary";
        if (yr === defaultYear) btn.classList.add("active");
        btn.innerText = yr;

        btn.addEventListener("click", function () {
          document
            .querySelectorAll("#yearButtons button")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          loadYear(yr);
        });

        btnGroup.appendChild(btn);
      });

      /* ===============================
     ä¸‰å€‹ toggle æŒ‰éˆ•ï¼ˆadded/persisted/disappearedï¼‰
  ================================== */

      function wireToggle(btnId, type) {
        const btn = document.getElementById(btnId);
        btn.addEventListener("click", () => {
          visible[type] = !visible[type];

          if (visible[type]) btn.classList.add("active");
          else btn.classList.remove("active");

          applyVisibility(type); // ä¸å‹•è¦–è§’
        });
      }

      wireToggle("btnAdded", "added");
      wireToggle("btnPersisted", "persisted");
      wireToggle("btnDisappeared", "disappeared");

      /* ===============================
     åˆå§‹è¼‰å…¥
  ================================== */

      loadYear(defaultYear);
    </script>
  </body>
</html>
